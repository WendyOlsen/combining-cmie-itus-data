---
title: "CMIE cleaning 1 & 2"
author: "Greg Campbell, Jihye Kim, Manasi Bera"
date: "28/08/2021"
output: html_document
---


STEPS COVERED IN DOCUMENT

1. IMPORT DATA
2. REARRANGE DATAFRAME TO MAKE IT EASIER TO READ
3. FILTER DATASET TO BALANCE PANEL AND EXCLUDING INDIVIDUALS YOUNGER THAN 15 AND OLDER THAN 65
4. GENERATING NEW VARIABLES INCLUDING AGE WHICH IS CATEGORICAL, OTHERTIME, WORKTIME AND HWORKTIME,
NEW FRACTIONAL VARIABLES (IF NEEDED), NEW EMPLOYMENT VARIABLE 
5. CREATING A NEW DATASET FOR MODELLING

Install any packages you don't yet have using the below commands. (these are more ones I use for the tables that will be generated.)
#install.packages("tidyverse")
#install.packages("haven")



```{r choose packages, include=FALSE}
library(tidyverse)
library(haven)
```

#### IMPORTING DATA ####


```{r import data, include=FALSE}


df<- readr::read_csv("C:/Users/USER/Dropbox (The University of Manchester)/IATUR/Model/Data/4waves.csv")

```


#### REARRANGING ORDER OF VARIABLES IN DATAFRAME #####

Rearrange into this order and in view(df), it helps readability

```{r include=FALSE}

df<-df %>% select(crosswavepid,hh_id, mem_id, wave_no, t1, t2, t3,t4,everything())
```

change order to more intuitive so can see alignment of how individuals line up.
For instance, by looking across t1, t2, t3 and t4, we can see which individuals appear in all 4 waves

```{r include=FALSE}
df <- df[order(df$hh_id, df$mem_id, df$wave_no),]
```


#### GENERATING FWT VARIABLE ####
```{r include=FALSE}
df$fwt <- as.integer(df$weight_15yrsplus/mean(df$weight_15yrsplus))
df$fwt[df$fwt==0] <- 1
```

#### GENERATING NEW AGE VARIABLE SPLIT INTO CATEGORIES ####

relocate age_yrs variable in the dataframe 

and view characteristics with cbind command in console


```{r include=FALSE}

df<-df %>% relocate(age_yrs, .after = crosswavehhid)

cbind(table(df$age_yrs, useNA = "always"))
```

```{r include=FALSE}
df$children_under13 <- as.numeric(df$age_yrs<13)
df$depndt_child_under13 <- ave(df$children_under13, df$unique_HHid, FUN = function(x) sum(as.numeric(x)))

df$havingchildunder13 <- as.numeric(df$depndt_child_under13>=1)
df$havingchildunder15 <- as.numeric(df$depndt_child>=1)
```

Filter age variable so those under 14 & above 65 are excluded from the sample

and view results in cbind in console

```{r  include=FALSE}

df<-df %>%     filter(age_yrs >= 15 & age_yrs <=65) 

cbind(table(df$age_yrs, useNA = "always"))  #check ages in table on console
```

create new split variable for age into three categories  of "15-24", "25-49", "50+"

```{r new categorised age variable, include=FALSE}
df$agesplit <-cut(df$age_yrs, breaks = c(14, 24, 49, 106 ), 
                      labels = c("15-24", "25-49", "50+")
                        )

df<-df %>% relocate(agesplit, .after = age_yrs)

```

view results in dashboard to show show age has been split 

```{r include=FALSE}
table(df$age_yrs,df$agesplit)

cbind(table(df$agesplit, useNA = "always"))
```


#### CREATING A BALANCED DATASET BY FILTERING ####


filter values so that only individuals who appear in four waves are included

```{r include=FALSE}

df <- df %>%
              group_by(crosswavepid) %>%
              filter(n()==4)
```



#### GENERATING NEW HTIME OTHERTIME, WORKTIME AND HWORKTIME VARIABLES ####




If there are any -100 values such as in the 11 activity variables
these can be reassigned with the value 0 but i don't think it's neccessary. Just check positions of the variables in the dataframe before running command to make sure they align

```{r}
### df[,35:45][ df[,37:47] == -100 ] <- 0   
```


check any variables if needed

```{r include=FALSE}

table(df$time_spent_on_work_for_hh_and_me)
table(df$time_spent_on_work_for_employer)
table(df$time_spent_on_work_as_unpaid_tra)
table(df$time_spent_on_work_as_unpaid_vol)
table(df$time_spent_on_travel)     
table(df$time_spent_on_learning)     
table(df$time_spent_on_religious_activiti)
table(df$time_spent_on_outdoor_sports) 
table(df$time_spent_on_hanging_out_or_wit)
table(df$time_spent_on_indoor_entertainme)
table(df$time_spent_on_other_activities_f)
```


#### CHANGING ORDER OF VARIOUS ACTIVITY VARIABLES IN THE DATAFRAME FOR EASIER READABILITY####

glimpse(df)

Moving activity based variables to the end of the dataframe to make it more readable and reorders the dataframe so that the 11 variables are in order 

```{r include=FALSE}
movetolast <- function(data, move) {
  data[c(setdiff(names(data), move), move)]
}

df<-movetolast(df, c(
"time_spent_on_hanging_out_or_wit", ### variables to be used for othertime 
 "time_spent_on_indoor_entertainme" ,
 "time_spent_on_learning"          ,
"time_spent_on_other_activities_f" ,
"time_spent_on_outdoor_sports"    ,
 "time_spent_on_religious_activiti" ,
 "time_spent_on_travel"            ,
 "time_spent_on_work_as_unpaid_tra",
 
 "time_spent_on_work_as_unpaid_vol" , ### variables to be used for worktime
  "time_spent_on_work_for_employer",

"time_spent_on_work_for_hh_and_me" )) ### variable to be used for hworktime 

glimpse(df)
```


#### GENERATING NEW OTHERTIME VARIABLE ####

Adding 8 variables together to make othertime and then multiplying the total by 60 to get minutes

```{r include=FALSE}
df$othertime<- (df$time_spent_on_hanging_out_or_wit +
 df$time_spent_on_indoor_entertainme +
 df$time_spent_on_learning          +
df$time_spent_on_other_activities_f +
df$time_spent_on_outdoor_sports    +
 df$time_spent_on_religious_activiti +
 df$time_spent_on_travel            +
 df$time_spent_on_work_as_unpaid_tra)*60

table(df$othertime)  
```


you'll also see if you do view(df), the end row has a new variable

#### GENERATING NEW WORKTIME VARIABLE ####



```{r include=FALSE}
df$worktime<- (df$time_spent_on_work_as_unpaid_vol + df$time_spent_on_work_for_employer)*60

table(df$worktime)
```

#### GENERATING NEW HWORKTIME VARIABLE ####


```{r include=FALSE}
df$hworktime<-(df$time_spent_on_work_for_hh_and_me)*60
table(df$hworktime)
```

check that all totals add together, you'll see all the 16864 cases add up to 1440

```{r include=FALSE}
df$overall<- df$othertime + df$worktime + df$hworktime

table(df$overall)
```

#### GENERATING NEW FRACTIONAL VARIABLE (IF NEEDED) ####

```{r include=FALSE}
df$frac_othertime<- (df$othertime)/1440
df$frac_worktime<- (df$worktime)/1440
df$frac_hworktime<- (df$hworktime)/1440

```


#### GENERATING UNEMPLOYED VARIABLE ####


for the next three chunks, these guide the process of generating the unemployed variable. This begins by 
making a new numeric variable called unem from the original employment_status variable

```{r include=FALSE}
cbind(table(df$employment_status, useNA = "always"))


df$unem<-as.numeric(as.factor(df$employment_status))                            


```

This table shows matching values between the original employment_status variable
and the new unem variable

```{r include=FALSE}
table(df$employment_status,df$unem)
```

A new variable, unemployed is generated and the correct values from the original categorical variable
are assigned values of 1 followed by deletion of the unem variable which is only temporary 

```{r unemployed chunk 2, include=FALSE}
df$unemployed<- 0 

df$unemployed[ df$unem %in% c(3,4)] <- 1 #Unemployed, willing and looking for a job 
                                        #  Unemployed, willing but not looking for a job     

table(df$unem,df$unemployed)

df$unem<-NULL
```



#### CREATING A NEW DATASET FOR MODELLING ####

```{r new dataset}
data_cmie <- df %>%  mutate (
        psid = crosswavepid,
        hhid = crosswavehhid,
        wave = wave_no-17,
        htime  = hworktime,
        etime  = worktime,
        wtime  = hworktime+worktime,
        fhtime = hworktime/1440,
        fetime = worktime/1440,
        fwtime = (hworktime+worktime)/1440,
        age = age_yrs,
        age2 = age_yrs*age_yrs,
        female=as.numeric(gender=="F"),
        urban=as.numeric(region_type=="URBAN"),
        hhsize = HHsize,
        evermarried=as.numeric(marital_status=="Married"|marital_status=="Diverced/Separated"|marital_status=="Widowed"),
        st=as.numeric(caste_category=="ST"),
        sc=as.numeric(caste_category=="SC"),
        lockdown=as.numeric(recode(wave, `1`="0", `2`="0.1", `3`="0.6", `4`="0.2")),
        belowprimary=as.numeric(education=="No Education"|education=="1st Std. Pass"|education=="2nd Std. Pass"|education=="3rd Std. Pass"|education=="4th Std. Pass"),
        primary_scndry=as.numeric(education=="5th Std. Pass"|education=="6th Std. Pass"|education=="7th Std. Pass"|education=="8th Std. Pass"|education=="9th Std. Pass"|education=="10th Std. Pass"),
        abovesecondary=as.numeric(education=="11th Std. Pass" | education=="12th Std. Pass"|education=="Graduate"|education=="Post Graduate"|education=="Ph.D / M.Phil"),
        depndt_child_under15=depndt_child, 
        weight=weight_15yrsplus)


             
data_cmie <- data_cmie %>% select(psid, hhid, wave, fwt, wtime, htime, etime, fwtime, fhtime, fetime, age, age2, female, urban,  hhsize, evermarried, depndt_child_under15, state, unemployed, st, sc, lockdown, belowprimary, primary_scndry, abovesecondary, depndt_child_under13, havingchildunder13, havingchildunder15, weight)
```

```{r centered or standardised variables}
data_cmie$age_c <- data_cmie$age-mean(data_cmie$age)
data_cmie$age2_z <- (data_cmie$age2-mean(data_cmie$age2))/sd(data_cmie$age2)
data_cmie$hhsize_c <- data_cmie$hhsize-mean(data_cmie$hhsize)
data_cmie$depndt_child_u15_pc <- data_cmie$depndt_child_under15/data_cmie$hhsize
summary(data_cmie)
```

summary()

#### SAVE .CSV FILE ####
```{r}
write.csv(data_cmie, "C:/Users/USER/Dropbox (The University of Manchester)/IATUR/Model/Data/data_cmie_16Sep.csv")
write.csv(summary(data_cmie), "C:/Users/USER/Dropbox (The University of Manchester)/IATUR/Model/Data/data_cmie_16Sep_summary.csv")
data_cmie <- read_csv("C:/Users/USER/Dropbox (The University of Manchester)/IATUR/Model/Data/data_cmie_16Sep.csv")
```
